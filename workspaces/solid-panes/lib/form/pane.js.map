{"version":3,"sources":["../../src/form/pane.js"],"names":["UI","require","$rdf","ns","module","exports","icon","icons","iconBase","name","audience","solid","label","subject","n","widgets","formsFor","length","log","debug","render","context","kb","session","store","dom","mention","complain","message","style","pre","createElement","setAttribute","box","appendChild","textContent","complainIfBad","ok","body","me","authn","currentUser","ws","each","ui","renderFormsFor","fetcher","nowOrWhenFetched","uri","forms","i","form","heading","formStore","Util","document","e","editFormButton","anchor","utils","appendForm","docuri","docpart","updater","editable","doc","any","sym","link","docs","docList","statementsMatching","forEach","st","why","undefined","d","push","sort","_followeach","path","oo","res","concat","slice","date","foobarbaz","selectWorkspace","activities","space","j","act","subjectDoc2","start","cal","value","end"],"mappings":"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","sourcesContent":["/*\n **                 Pane for running existing forms for any object\n **\n */\n\nconst UI = require('solid-ui')\nconst $rdf = require('rdflib')\nconst ns = UI.ns\n\nmodule.exports = {\n  icon: UI.icons.iconBase + 'noun_122196.svg',\n\n  name: 'form',\n\n  audience: [ns.solid('PowerUser')],\n\n  // Does the subject deserve this pane?\n  label: function (subject) {\n    const n = UI.widgets.formsFor(subject).length\n    UI.log.debug('Form pane: forms for ' + subject + ': ' + n)\n    if (!n) return null\n    return '' + n + ' forms'\n  },\n\n  render: function (subject, context) {\n    const kb = context.session.store\n    const dom = context.dom\n\n    const mention = function complain (message, style) {\n      const pre = dom.createElement('p')\n      pre.setAttribute('style', style || 'color: grey; background-color: white')\n      box.appendChild(pre).textContent = message\n      return pre\n    }\n\n    const complain = function complain (message, style) {\n      mention(message, 'style', style || 'color: grey; background-color: #fdd;')\n    }\n\n    const complainIfBad = function (ok, body) {\n      if (ok) {\n        // setModifiedDate(store, kb, store);\n        // rerender(box);   // Deleted forms at the moment\n      } else complain('Sorry, failed to save your change:\\n' + body)\n    }\n\n    // The question of where to store this data about subject\n    // This in general needs a whole lot more thought\n    // and it connects to the discoverbility through links\n\n    // var t = kb.findTypeURIs(subject)\n\n    const me = UI.authn.currentUser()\n\n    var box = dom.createElement('div')\n    box.setAttribute('class', 'formPane')\n\n    if (!me) {\n      mention(\n        'You are not logged in. If you log in and have ' +\n          'workspaces then you would be able to select workspace in which ' +\n          'to put this new information'\n      )\n    } else {\n      const ws = kb.each(me, ns.ui('workspace'))\n      if (ws.length === 0) {\n        mention(\n          \"You don't seem to have any workspaces defined.  \" +\n            'A workspace is a place on the web (http://..) or in ' +\n            'the file system (file:///) to store application data.\\n'\n        )\n      } else {\n        // @@\n      }\n    }\n\n    // Render forms using a given store\n\n    const renderFormsFor = function (store, subject) {\n      kb.fetcher.nowOrWhenFetched(store.uri, subject, function (ok, body) {\n        if (!ok) return complain('Cannot load store ' + store.uri + ': ' + body)\n\n        //              Render the forms\n\n        const forms = UI.widgets.formsFor(subject)\n\n        // complain('Form for editing this form:');\n        for (let i = 0; i < forms.length; i++) {\n          const form = forms[i]\n          const heading = dom.createElement('h4')\n          box.appendChild(heading)\n          if (form.uri) {\n            const formStore = $rdf.Util.uri.document(form)\n            if (formStore.uri !== form.uri) {\n              // The form is a hash-type URI\n              const e = box.appendChild(\n                UI.widgets.editFormButton(\n                  dom,\n                  box,\n                  form,\n                  formStore,\n                  complainIfBad\n                )\n              )\n              e.setAttribute('style', 'float: right;')\n            }\n          }\n          const anchor = dom.createElement('a')\n          anchor.setAttribute('href', form.uri)\n          heading.appendChild(anchor)\n          anchor.textContent = UI.utils.label(form, true)\n\n          /*  Keep tis as a reminder to let a New one have its URI given by user\n          mention(\"Where will this information be stored?\")\n          var ele = dom.createElement('input');\n          box.appendChild(ele);\n          ele.setAttribute('type', 'text');\n          ele.setAttribute('size', '72');\n          ele.setAttribute('maxlength', '1024');\n          ele.setAttribute('style', 'font-size: 80%; color:#222;');\n          ele.value = store.uri\n          */\n\n          UI.widgets.appendForm(\n            dom,\n            box,\n            {},\n            subject,\n            form,\n            store,\n            complainIfBad\n          )\n        }\n      }) // end: when store loded\n    } // renderFormsFor\n\n    // Figure out what store\n\n    // Which places are editable and have stuff about the subject?\n\n    let store = null\n\n    // 1. The document URI of the subject itself\n    const docuri = $rdf.Util.uri.docpart(subject.uri)\n    if (subject.uri !== docuri && kb.updater.editable(docuri, kb)) {\n      store = subject.doc()\n    } // an editable data file with hash\n\n    store = store || kb.any(kb.sym(docuri), ns.link('annotationStore'))\n\n    // 2. where stuff is already stored\n    if (!store) {\n      const docs = {}\n      const docList = []\n      store.statementsMatching(subject).forEach(function (st) {\n        docs[st.why.uri] = 1\n      })\n      store\n        .statementsMatching(undefined, undefined, subject)\n        .forEach(function (st) {\n          docs[st.why.uri] = 2\n        })\n      for (const d in docs) docList.push(docs[d], d)\n      docList.sort()\n      for (var i = 0; i < docList.length; i++) {\n        const uri = docList[i][1]\n        if (uri && store.updater.editable(uri)) {\n          store = store.sym(uri)\n          break\n        }\n      }\n    }\n\n    // 3. In a workspace store\n    // @@ TODO: Can probably remove _followeach (not done this time because the commit is a very safe refactor)\n    var _followeach = function (kb, subject, path) {\n      if (path.length === 0) return [subject]\n      const oo = kb.each(subject, path[0])\n      let res = []\n      for (let i = 0; i < oo.length; i++) {\n        res = res.concat(_followeach(kb, oo[i], path.slice(1)))\n      }\n      return res\n    }\n\n    const date = '2014' // @@@@@@@@@@@@ pass as parameter\n\n    if (store) {\n      // mention(\"@@ Ok, we have a store <\" + store.uri + \">.\");\n      renderFormsFor(store, subject)\n    } else {\n      complain('No suitable store is known, to edit <' + subject.uri + '>.')\n      const foobarbaz = UI.authn.selectWorkspace(dom, function (ws) {\n        mention('Workspace selected OK: ' + ws)\n\n        const activities = store.each(undefined, ns.space('workspace'), ws)\n        for (let j = 0; j < activities.length; i++) {\n          const act = activities[j]\n\n          const subjectDoc2 = store.any(ws, ns.space('store'))\n          const start = store.any(ws, ns.cal('dtstart')).value()\n          const end = store.any(ws, ns.cal('dtend')).value()\n          if (subjectDoc2 && start && end && start <= date && end > date) {\n            renderFormsFor(subjectDoc2, subject)\n            break\n          } else {\n            complain('Note no suitable annotation store in activity: ' + act)\n          }\n        }\n      })\n      box.appendChild(foobarbaz)\n    }\n\n    return box\n  }\n}\n"],"file":"pane.js"}