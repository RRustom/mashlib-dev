{"version":3,"sources":["../../src/ui/pane.js"],"names":["UI","require","$rdf","ns","module","exports","icon","icons","iconBase","name","audience","solid","label","subject","context","kb","session","store","t","findTypeURIs","rdfs","uri","ui","render","dom","box","createElement","setAttribute","utils","mention","complain","message","style","pre","appendChild","textContent","complainIfBad","ok","body","docuri","Util","docpart","updater","editable","sym","any","link","widgets","defaultAnnotationStore","pred","wait","fetcher","nowOrWhenFetched","removeChild","displayFormsForRelation","allowCreation","sts","statementsMatching","outliner","getOutliner","length","i","appendPropertyTRs","form","object","cell","lastChild","newButton","formdef","rdf","editFormButton","why","appendForm"],"mappings":";;AAAA;AACA;AACA;AAEA,IAAMA,EAAE,GAAGC,OAAO,CAAC,UAAD,CAAlB;;AACA,IAAMC,IAAI,GAAGD,OAAO,CAAC,QAAD,CAApB;;AACA,IAAME,EAAE,GAAGH,EAAE,CAACG,EAAd;AAEAC,MAAM,CAACC,OAAP,GAAiB;AACf;AACAC,EAAAA,IAAI,EAAEN,EAAE,CAACO,KAAH,CAASC,QAAT,GAAoB,iBAFX;AAIfC,EAAAA,IAAI,EAAE,IAJS;AAMfC,EAAAA,QAAQ,EAAE,CAACP,EAAE,CAACQ,KAAH,CAAS,WAAT,CAAD,CANK;AAQf;AACAC,EAAAA,KAAK,EAAE,eAAUC,OAAV,EAAmBC,OAAnB,EAA4B;AACjC,QAAMX,EAAE,GAAGH,EAAE,CAACG,EAAd;AACA,QAAMY,EAAE,GAAGD,OAAO,CAACE,OAAR,CAAgBC,KAA3B;AACA,QAAMC,CAAC,GAAGH,EAAE,CAACI,YAAH,CAAgBN,OAAhB,CAAV;AACA,QAAIK,CAAC,CAACf,EAAE,CAACiB,IAAH,CAAQ,OAAR,EAAiBC,GAAlB,CAAL,EAA6B,OAAO,gBAAP,CAJI,CAKjC;;AACA,QAAIH,CAAC,CAACf,EAAE,CAACmB,EAAH,CAAM,MAAN,EAAcD,GAAf,CAAL,EAA0B,OAAO,WAAP;AAE1B,WAAO,IAAP,CARiC,CAQrB;AACb,GAlBc;AAoBfE,EAAAA,MAAM,EAAE,gBAAUV,OAAV,EAAmBC,OAAnB,EAA4B;AAClC,QAAMU,GAAG,GAAGV,OAAO,CAACU,GAApB;AACA,QAAMT,EAAE,GAAGD,OAAO,CAACE,OAAR,CAAgBC,KAA3B;AACA,QAAMd,EAAE,GAAGH,EAAE,CAACG,EAAd;AAEA,QAAMsB,GAAG,GAAGD,GAAG,CAACE,aAAJ,CAAkB,KAAlB,CAAZ;AACAD,IAAAA,GAAG,CAACE,YAAJ,CAAiB,OAAjB,EAA0B,UAA1B,EANkC,CAMI;;AACtC,QAAMf,KAAK,GAAGZ,EAAE,CAAC4B,KAAH,CAAShB,KAAT,CAAeC,OAAf,CAAd;;AAEA,QAAMgB,OAAO,GAAG,SAASC,QAAT,CAAmBC,OAAnB,EAA4BC,KAA5B,EAAmC;AACjD,UAAMC,GAAG,GAAGT,GAAG,CAACE,aAAJ,CAAkB,GAAlB,CAAZ;AACAO,MAAAA,GAAG,CAACN,YAAJ,CAAiB,OAAjB,EAA0BK,KAAK,IAAI,sCAAnC;AACAP,MAAAA,GAAG,CAACS,WAAJ,CAAgBD,GAAhB,EAAqBE,WAArB,GAAmCJ,OAAnC;AACA,aAAOE,GAAP;AACD,KALD;;AAOA,QAAMH,QAAQ,GAAG,SAASA,QAAT,CAAmBC,OAAnB,EAA4BC,KAA5B,EAAmC;AAClDH,MAAAA,OAAO,CAACE,OAAD,EAAU,OAAV,EAAmBC,KAAK,IAAI,qCAA5B,CAAP;AACD,KAFD;;AAIA,QAAMI,aAAa,GAAG,SAAhBA,aAAgB,CAAUC,EAAV,EAAcC,IAAd,EAAoB;AACxC,UAAID,EAAJ,EAAQ,CACN;AACA;AACD,OAHD,MAGOP,QAAQ,CAAC,yCAAyCQ,IAA1C,CAAR;AACR,KALD,CApBkC,CA2BlC;;;AAEA,QAAMpB,CAAC,GAAGH,EAAE,CAACI,YAAH,CAAgBN,OAAhB,CAAV;AAEA,QAAII,KAAK,GAAG,IAAZ;;AACA,QAAIJ,OAAO,CAACQ,GAAZ,EAAiB;AACf,UAAIkB,MAAM,GAAGrC,IAAI,CAACsC,IAAL,CAAUnB,GAAV,CAAcoB,OAAd,CAAsB5B,OAAO,CAACQ,GAA9B,CAAb;;AACA,UAAIR,OAAO,CAACQ,GAAR,KAAgBkB,MAAhB,IAA0BxB,EAAE,CAAC2B,OAAH,CAAWC,QAAX,CAAoBJ,MAApB,CAA9B,EAA2D;AACzDtB,QAAAA,KAAK,GAAGF,EAAE,CAAC6B,GAAH,CAAO1C,IAAI,CAACsC,IAAL,CAAUnB,GAAV,CAAcoB,OAAd,CAAsB5B,OAAO,CAACQ,GAA9B,CAAP,CAAR;AACD,OAJc,CAIb;;AACH;;AACD,QAAI,CAACJ,KAAL,EAAYA,KAAK,GAAGF,EAAE,CAAC8B,GAAH,CAAO9B,EAAE,CAAC6B,GAAH,CAAOL,MAAP,CAAP,EAAuBpC,EAAE,CAAC2C,IAAH,CAAQ,iBAAR,CAAvB,CAAR;AACZ,QAAI,CAAC7B,KAAL,EAAYA,KAAK,GAAGjB,EAAE,CAAC+C,OAAH,CAAWC,sBAAX,CAAkCnC,OAAlC,CAAR;;AAEZ,QAAI,CAACI,KAAL,EAAY;AACVA,MAAAA,KAAK,GAAGF,EAAE,CAAC6B,GAAH,CACN,4DADM,CAAR,CADU,CAGR;AACH,KA7CiC,CA8ClC;AAEA;;;AAEA,QAAIK,IAAJ;;AACA,QAAI/B,CAAC,CAACf,EAAE,CAACiB,IAAH,CAAQ,OAAR,EAAiBC,GAAlB,CAAL,EAA6B,CAC3B;AACD;;AAED,QAAM6B,IAAI,GAAGrB,OAAO,CAAC,yBAAyBZ,KAAzB,GAAiC,GAAlC,CAApB;AAEAF,IAAAA,EAAE,CAACoC,OAAH,CAAWC,gBAAX,CAA4BnC,KAAK,CAACI,GAAlC,EAAuCR,OAAvC,EAAgD,UAAUwB,EAAV,EAAcC,IAAd,EAAoB;AAClE,UAAI,CAACD,EAAL,EAAS;AACPP,QAAAA,QAAQ,CAAC,uBAAuBb,KAAvB,GAA+B,IAA/B,GAAsCqB,IAAvC,CAAR;AACA;AACD;;AACDb,MAAAA,GAAG,CAAC4B,WAAJ,CAAgBH,IAAhB,EALkE,CAOlE;;AAEA,UAAIhC,CAAC,CAACf,EAAE,CAACiB,IAAH,CAAQ,OAAR,EAAiBC,GAAlB,CAAL,EAA6B;AAC3B;AACA,YAAMiC,uBAAuB,GAAG,SAASA,uBAAT,CAC9BL,IAD8B,EAE9BM,aAF8B,EAG9B;AACA,cAAMC,GAAG,GAAGzC,EAAE,CAAC0C,kBAAH,CAAsB5C,OAAtB,EAA+BoC,IAA/B,CAAZ;AACA,cAAMS,QAAQ,GAAG5C,OAAO,CAAC6C,WAAR,CAAoBnC,GAApB,CAAjB;;AACA,cAAIgC,GAAG,CAACI,MAAR,EAAgB;AACd,iBAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGL,GAAG,CAACI,MAAxB,EAAgCC,CAAC,EAAjC,EAAqC;AACnCH,cAAAA,QAAQ,CAACI,iBAAT,CAA2BrC,GAA3B,EAAgC,CAAC+B,GAAG,CAACK,CAAD,CAAJ,CAAhC;AACA,kBAAME,IAAI,GAAGP,GAAG,CAACK,CAAD,CAAH,CAAOG,MAApB;AACA,kBAAMC,IAAI,GAAGzC,GAAG,CAACE,aAAJ,CAAkB,IAAlB,CAAb;AACAD,cAAAA,GAAG,CAACyC,SAAJ,CAAchC,WAAd,CAA0B+B,IAA1B;;AACA,kBAAIV,aAAJ,EAAmB;AACjBU,gBAAAA,IAAI,CAAC/B,WAAL,CACElC,EAAE,CAAC+C,OAAH,CAAWoB,SAAX,CACE3C,GADF,EAEET,EAFF,EAGE,IAHF,EAIE,IAJF,EAKEF,OALF,EAMEkD,IANF,EAOE9C,KAPF,EAQE,UAAUoB,EAAV,EAAcC,IAAd,EAAoB;AAClB,sBAAID,EAAJ,EAAQ,CACN;AACA;AACD,mBAHD,MAGO;AACLP,oBAAAA,QAAQ,CAAC,yCAAyCQ,IAA1C,CAAR;AACD;AACF,iBAfH,CADF;AAmBD;;AACD,kBAAI8B,OAAO,GAAGrD,EAAE,CAAC0C,kBAAH,CAAsBM,IAAtB,EAA4B5D,EAAE,CAACkE,GAAH,CAAO,MAAP,CAA5B,CAAd;AACA,kBAAI,CAACD,OAAO,CAACR,MAAb,EAAqBQ,OAAO,GAAGrD,EAAE,CAAC0C,kBAAH,CAAsBM,IAAtB,CAAV;AACrB,kBAAI,CAACK,OAAO,CAACR,MAAb,EAAqB9B,QAAQ,CAAC,oBAAD,CAAR,CAArB,KACK;AACH9B,gBAAAA,EAAE,CAAC+C,OAAH,CAAWuB,cAAX,CACE9C,GADF,EAEEC,GAFF,EAGEsC,IAHF,EAIEK,OAAO,CAAC,CAAD,CAAP,CAAWG,GAJb,EAKEnC,aALF;AAOD;AACF;;AACDX,YAAAA,GAAG,CAACS,WAAJ,CAAgBV,GAAG,CAACE,aAAJ,CAAkB,IAAlB,CAAhB;AACD,WAzCD,MAyCO;AACLG,YAAAA,OAAO,CACL,kDAAkDjB,KAAlD,GAA0D,GADrD,CAAP;AAGD;AACF,SApDD;;AAsDAqC,QAAAA,IAAI,GAAG9C,EAAE,CAACmB,EAAH,CAAM,cAAN,CAAP;AACAG,QAAAA,GAAG,CAACS,WAAJ,CAAgBV,GAAG,CAACE,aAAJ,CAAkB,IAAlB,CAAhB,EAAyCS,WAAzC,GAAuDnC,EAAE,CAAC4B,KAAH,CAAShB,KAAT,CACrDqC,IADqD,CAAvD;AAGApB,QAAAA,OAAO,CACL,mEACE,sBADF,GAEEjB,KAFF,GAGE,GAJG,CAAP;AAMA0C,QAAAA,uBAAuB,CAACL,IAAD,EAAO,IAAP,CAAvB;AACAxB,QAAAA,GAAG,CAACS,WAAJ,CAAgBV,GAAG,CAACE,aAAJ,CAAkB,IAAlB,CAAhB;AACAG,QAAAA,OAAO,CAAC,mCAAD,CAAP;AACAJ,QAAAA,GAAG,CAACS,WAAJ,CACElC,EAAE,CAAC+C,OAAH,CAAWoB,SAAX,CACE3C,GADF,EAEET,EAFF,EAGEF,OAHF,EAIEoC,IAJF,EAKE9C,EAAE,CAACmB,EAAH,CAAM,MAAN,CALF,EAME,IANF,EAOEL,KAPF,EAQEmB,aARF,CADF;AAaAX,QAAAA,GAAG,CAACS,WAAJ,CAAgBV,GAAG,CAACE,aAAJ,CAAkB,IAAlB,CAAhB;AAEAuB,QAAAA,IAAI,GAAG9C,EAAE,CAACmB,EAAH,CAAM,gBAAN,CAAP;AACAG,QAAAA,GAAG,CAACS,WAAJ,CAAgBV,GAAG,CAACE,aAAJ,CAAkB,IAAlB,CAAhB,EAAyCS,WAAzC,GAAuDnC,EAAE,CAAC4B,KAAH,CAAShB,KAAT,CACrDqC,IADqD,CAAvD;AAGApB,QAAAA,OAAO,CACL,iEACEjB,KADF,GAEE,yBAHG,CAAP;AAKA0C,QAAAA,uBAAuB,CAACL,IAAD,EAAO,KAAP,CAAvB;AACAxB,QAAAA,GAAG,CAACS,WAAJ,CAAgBV,GAAG,CAACE,aAAJ,CAAkB,IAAlB,CAAhB;AACAG,QAAAA,OAAO,CAAC,qCAAD,CAAP;AACAJ,QAAAA,GAAG,CAACS,WAAJ,CACElC,EAAE,CAAC+C,OAAH,CAAWoB,SAAX,CACE3C,GADF,EAEET,EAFF,EAGEF,OAHF,EAIEoC,IAJF,EAKE9C,EAAE,CAACmB,EAAH,CAAM,MAAN,CALF,EAME,IANF,EAOEL,KAPF,EAQEmB,aARF,CADF;AAaAP,QAAAA,OAAO,CAAC,4BAA4BZ,KAA5B,GAAoC,GAArC,CAAP,CA7G2B,CA+G3B;AACD,OAhHD,MAgHO,IAAIC,CAAC,CAACf,EAAE,CAACmB,EAAH,CAAM,MAAN,EAAcD,GAAf,CAAL,EAA0B;AAC/BrB,QAAAA,EAAE,CAAC+C,OAAH,CAAWyB,UAAX,CACEhD,GADF,EAEEC,GAFF,EAGEV,EAHF,EAIEF,OAJF,EAKEV,EAAE,CAACmB,EAAH,CAAM,UAAN,CALF,EAMEL,KANF,EAOEmB,aAPF;AASD,OAVM,MAUA;AACLN,QAAAA,QAAQ,CAAC,+BAAD,CAAR;AACD;AACF,KAtID,EAzDkC,CA+L/B;;AAEH,WAAOL,GAAP;AACD;AAtNc,CAAjB,C,CAwNA","sourcesContent":["/*   Form building/editing Pane\n **\n */\n\nconst UI = require('solid-ui')\nconst $rdf = require('rdflib')\nconst ns = UI.ns\n\nmodule.exports = {\n  // noun_170702.svg' builder   noun_122196.svg form\n  icon: UI.icons.iconBase + 'noun_170702.svg',\n\n  name: 'ui',\n\n  audience: [ns.solid('PowerUser')],\n\n  // Does the subject deserve this pane?\n  label: function (subject, context) {\n    const ns = UI.ns\n    const kb = context.session.store\n    const t = kb.findTypeURIs(subject)\n    if (t[ns.rdfs('Class').uri]) return 'creation forms'\n    // if (t[ns.rdf('Property').uri]) return \"user interface\";\n    if (t[ns.ui('Form').uri]) return 'edit form'\n\n    return null // No under other circumstances (while testing at least!)\n  },\n\n  render: function (subject, context) {\n    const dom = context.dom\n    const kb = context.session.store\n    const ns = UI.ns\n\n    const box = dom.createElement('div')\n    box.setAttribute('class', 'formPane') // Share styles\n    const label = UI.utils.label(subject)\n\n    const mention = function complain (message, style) {\n      const pre = dom.createElement('p')\n      pre.setAttribute('style', style || 'color: grey; background-color: white')\n      box.appendChild(pre).textContent = message\n      return pre\n    }\n\n    const complain = function complain (message, style) {\n      mention(message, 'style', style || 'color: grey; background-color: #fdd')\n    }\n\n    const complainIfBad = function (ok, body) {\n      if (ok) {\n        // setModifiedDate(store, kb, store);\n        // rerender(box);   // Deleted forms at the moment\n      } else complain('Sorry, failed to save your change:\\n' + body)\n    }\n\n    // //////////////////////////////////////////////////////////////////////////////\n\n    const t = kb.findTypeURIs(subject)\n\n    let store = null\n    if (subject.uri) {\n      var docuri = $rdf.Util.uri.docpart(subject.uri)\n      if (subject.uri !== docuri && kb.updater.editable(docuri)) {\n        store = kb.sym($rdf.Util.uri.docpart(subject.uri))\n      } // an editable ontology with hash\n    }\n    if (!store) store = kb.any(kb.sym(docuri), ns.link('annotationStore'))\n    if (!store) store = UI.widgets.defaultAnnotationStore(subject)\n\n    if (!store) {\n      store = kb.sym(\n        'https://formsregistry.solid.community/public/formRegistry/'\n      ) // fallback\n    }\n    // if (!store) store = kb.sym('http://tabulator.org/wiki/ontologyAnnotation/common') // fallback\n\n    // A fallback which gives a different store page for each ontology would be good @@\n\n    let pred\n    if (t[ns.rdfs('Class').uri]) {\n      // Stuff we can do before we load the store\n    }\n\n    const wait = mention('(Loading data from: ' + store + ')')\n\n    kb.fetcher.nowOrWhenFetched(store.uri, subject, function (ok, body) {\n      if (!ok) {\n        complain('Cannot load store ' + store + ' :' + body)\n        return\n      }\n      box.removeChild(wait)\n\n      //              Render a Class -- the forms associated with it\n\n      if (t[ns.rdfs('Class').uri]) {\n        // For each creation form, allow one to create a new object with it, and also to edit the form.\n        const displayFormsForRelation = function displayFormsForRelation (\n          pred,\n          allowCreation\n        ) {\n          const sts = kb.statementsMatching(subject, pred)\n          const outliner = context.getOutliner(dom)\n          if (sts.length) {\n            for (let i = 0; i < sts.length; i++) {\n              outliner.appendPropertyTRs(box, [sts[i]])\n              const form = sts[i].object\n              const cell = dom.createElement('td')\n              box.lastChild.appendChild(cell)\n              if (allowCreation) {\n                cell.appendChild(\n                  UI.widgets.newButton(\n                    dom,\n                    kb,\n                    null,\n                    null,\n                    subject,\n                    form,\n                    store,\n                    function (ok, body) {\n                      if (ok) {\n                        // dom.outlineManager.GotoSubject(newThing@@, true, undefined, true, undefined);\n                        // rerender(box);   // Deleted forms at the moment\n                      } else {\n                        complain('Sorry, failed to save your change:\\n' + body)\n                      }\n                    }\n                  )\n                )\n              }\n              let formdef = kb.statementsMatching(form, ns.rdf('type'))\n              if (!formdef.length) formdef = kb.statementsMatching(form)\n              if (!formdef.length) complain('No data about form')\n              else {\n                UI.widgets.editFormButton(\n                  dom,\n                  box,\n                  form,\n                  formdef[0].why,\n                  complainIfBad\n                )\n              }\n            }\n            box.appendChild(dom.createElement('hr'))\n          } else {\n            mention(\n              'There are currently no known forms to make a ' + label + '.'\n            )\n          }\n        }\n\n        pred = ns.ui('creationForm')\n        box.appendChild(dom.createElement('h2')).textContent = UI.utils.label(\n          pred\n        )\n        mention(\n          'Creation forms allow you to add information about a new thing,' +\n            ' in this case a new ' +\n            label +\n            '.'\n        )\n        displayFormsForRelation(pred, true)\n        box.appendChild(dom.createElement('hr'))\n        mention('You can make a new creation form:')\n        box.appendChild(\n          UI.widgets.newButton(\n            dom,\n            kb,\n            subject,\n            pred,\n            ns.ui('Form'),\n            null,\n            store,\n            complainIfBad\n          )\n        )\n\n        box.appendChild(dom.createElement('hr'))\n\n        pred = ns.ui('annotationForm')\n        box.appendChild(dom.createElement('h2')).textContent = UI.utils.label(\n          pred\n        )\n        mention(\n          'Annotaion forms allow you to add extra information about a ,' +\n            label +\n            ' we already know about.'\n        )\n        displayFormsForRelation(pred, false)\n        box.appendChild(dom.createElement('hr'))\n        mention('You can make a new annotation form:')\n        box.appendChild(\n          UI.widgets.newButton(\n            dom,\n            kb,\n            subject,\n            pred,\n            ns.ui('Form'),\n            null,\n            store,\n            complainIfBad\n          )\n        )\n\n        mention('(Storing new forms in: ' + store + ')')\n\n        // Render a Form\n      } else if (t[ns.ui('Form').uri]) {\n        UI.widgets.appendForm(\n          dom,\n          box,\n          kb,\n          subject,\n          ns.ui('FormForm'),\n          store,\n          complainIfBad\n        )\n      } else {\n        complain('ui/pane internal error -- Eh?')\n      }\n    }) // end: when store loded\n\n    return box\n  }\n}\n// ends\n"],"file":"pane.js"}