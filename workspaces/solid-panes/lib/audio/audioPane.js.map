{"version":3,"sources":["../../src/audio/audioPane.js"],"names":["UI","require","$rdf","ns","module","exports","icon","icons","iconBase","name","label","subject","context","kb","session","store","typeURIs","findTypeURIs","prefix","Util","mediaTypeClass","uri","split","t","startsWith","render","dom","options","autoplay","chain","chainAlbums","loop","removeExtension","str","dot","lastIndexOf","slash","slice","looksRedundant","x","folder","any","undefined","ldp","contents","each","length","thisName","k","otherName","endsWith","guessNames","a","decode","decodeURIComponent","e","artistRow","textContent","albumRow","trackRow","moveOn","current","level","Promise","resolve","dir","fetcher","load","then","_xhr","j","sort","i","folder2","console","log","endedListener","event","sym","target","getAttribute","tryNext","cur","next","controlRow","appendChild","audioControl","removeChild","song","audio","createElement","setAttribute","addEventListener","div","table","labelStyle","style","cssText","holds"],"mappings":"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","sourcesContent":["/*   Single audio play Pane\n **\n */\nconst UI = require('solid-ui')\nconst $rdf = require('rdflib')\nconst ns = UI.ns\n\nmodule.exports = {\n  icon: UI.icons.iconBase + 'noun_534313.svg',\n\n  name: 'audio',\n\n  // Does the subject deserve an audio play pane?\n  label: function (subject, context) {\n    const kb = context.session.store\n    const typeURIs = kb.findTypeURIs(subject)\n\n    const prefix = $rdf.Util.mediaTypeClass('audio/*').uri.split('*')[0]\n    for (const t in typeURIs) {\n      if (t.startsWith(prefix)) return 'Play audio'\n    }\n    return null\n  },\n\n  render: function (subject, context) {\n    const kb = context.session.store\n    const dom = context.dom\n    const options = {\n      autoplay: false,\n      chain: true,\n      chainAlbums: true,\n      loop: false\n    }\n\n    const removeExtension = function (str) {\n      const dot = str.lastIndexOf('.')\n      if (dot < 0) return str // if any\n      const slash = str.lastIndexOf('/')\n      if (dot < slash) return str\n      return str.slice(0, dot)\n    }\n\n    // True if there is another file like song.mp3 when this is \"song 1.mp3\"\n    // or this is song.m4a\n    //\n    const looksRedundant = function (x) {\n      const folder = kb.any(undefined, ns.ldp('contains'), x)\n      if (!folder) return false\n      const contents = kb.each(folder, ns.ldp('contains'))\n      if (contents.length < 2) return false\n      const thisName = x.uri\n      for (let k = 0; k < contents.length; k++) {\n        const otherName = contents[k].uri\n        if (\n          thisName.length > otherName.length &&\n          thisName.startsWith(removeExtension(otherName))\n        ) {\n          return true\n        }\n        if (\n          thisName.endsWith('.m4a') &&\n          otherName.endsWith('.mp3') &&\n          removeExtension(thisName) === removeExtension(otherName)\n        ) {\n          return true\n        }\n      }\n      return false\n    }\n\n    // Alternative methods could include:\n    // Accesing metadata in the audio contol, or paring the audio file\n    const guessNames = function (x) {\n      const a = x.uri.split('/').slice(-3) // Hope artist, album, track\n      const decode = function (str) {\n        try {\n          return decodeURIComponent(str)\n        } catch (e) {\n          return str\n        }\n      }\n      artistRow.textContent = decode(a[0])\n      albumRow.textContent = decode(a[1])\n      trackRow.textContent = decode(removeExtension(a[2]))\n    }\n\n    var moveOn = function (current, level) {\n      return new Promise(function (resolve) {\n        level = level || 0\n        if (!options.chain) return resolve(null)\n        // Ideally navigate graph else cheat with URI munging:\n        const folder =\n          kb.any(undefined, ns.ldp('contains'), current) || current.dir()\n        if (!folder) return resolve(null)\n        kb.fetcher.load(folder).then(function (_xhr) {\n          const contents = kb.each(folder, ns.ldp('contains')) // @@ load if not loaded\n          // if (contents.length < 2) return resolve(null)   NO might move on from 1-track album\n          let j\n          contents.sort() // sort by URI which hopefully will get tracks in order\n          for (let i = 0; i < contents.length; i++) {\n            if (current.uri === contents[i].uri) {\n              j = (i + 1) % contents.length\n              if (j === 0) {\n                if (!options.chainAlbums) {\n                  if (options.loop) {\n                    return resolve(contents[j])\n                  }\n                  return resolve(null) // No more music needed\n                } else {\n                  // chain albums\n                  if (level === 1 || !options.chainAlbums) return resolve(null) // limit of navigating treee\n                  moveOn(folder, level + 1).then(function (folder2) {\n                    if (folder2) {\n                      kb.fetcher.load(folder2).then(function (_xhr) {\n                        const contents = kb.each(folder2, ns.ldp('contains'))\n                        if (contents.length === 0) return resolve(null)\n                        contents.sort()\n                        console.log('New Album: ' + folder2)\n                        return resolve(contents[0]) // Start off new album\n                      })\n                    }\n                  })\n                }\n              } else {\n                return resolve(contents[j])\n              }\n            }\n          } // for\n        })\n      })\n    }\n    const endedListener = function (event) {\n      const current = kb.sym(event.target.getAttribute('src'))\n      if (!options.chain) return\n      var tryNext = function (cur) {\n        const current = cur\n        moveOn(current).then(function (next) {\n          if (!next) {\n            console.log('No successor to ' + current)\n            return\n          }\n          if (!looksRedundant(next)) {\n            console.log('Moving on to ' + next)\n            guessNames(next)\n            controlRow.appendChild(audioControl(next, true)) // Force autoplay\n            controlRow.removeChild(event.target)\n          } else {\n            console.log('Ignoring redundant ' + next)\n            tryNext(next)\n          }\n        })\n      }\n      tryNext(current)\n    }\n\n    var audioControl = function (song, autoplay) {\n      const audio = dom.createElement('audio')\n      audio.setAttribute('controls', 'yes')\n      audio.setAttribute('src', song.uri)\n      if (autoplay) {\n        audio.setAttribute('autoplay', 'autoplay') // Make this a personal preference\n      }\n      audio.addEventListener('ended', endedListener, false)\n      return audio\n    }\n\n    const div = dom.createElement('div')\n    const table = div.appendChild(dom.createElement('table'))\n    const labelStyle = 'padding: 0.3em; color:white; background-color: black;'\n    var artistRow = table.appendChild(dom.createElement('tr'))\n    artistRow.style.cssText = labelStyle\n    var albumRow = table.appendChild(dom.createElement('tr'))\n    albumRow.style.cssText = labelStyle\n    var trackRow = table.appendChild(dom.createElement('tr'))\n    trackRow.style.cssText = labelStyle\n    var controlRow = table.appendChild(dom.createElement('tr'))\n    guessNames(subject)\n    controlRow.appendChild(audioControl(subject, options.autoplay))\n\n    if (!kb.holds(undefined, ns.ldp('contains'), subject) && subject.dir()) {\n      kb.fetcher.load(subject.dir()) // Prefetch enclosing @@ or playlist\n    }\n\n    return div\n  }\n}\n\n// ends\n"],"file":"audioPane.js"}