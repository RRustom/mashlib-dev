{"version":3,"sources":["../../src/trip/tripPane.js"],"names":["UI","require","$rdf","ns","module","exports","icon","icons","iconBase","name","audience","solid","label","subject","context","kb","session","store","t","findTypeURIs","qu","findSuperClassesNT","render","myDocument","dom","CAL","Namespace","TRIP","div","createElement","setAttribute","innerHTML","complain","message","style","undefined","pre","appendChild","createTextNode","renderTrip","thisDiv","query","Query","utils","vars","v","forEach","x","push","variable","pat","add","transaction","opt","formula","rdf","type","optional","date","rdfs","comment","in_USD","calculations","total","trans","each","ty","the","uri","tyuri","lit","any","parseFloat","value","str","types","grandTotal","sym","length","tableDiv","table","onDone","ts","triples","index","i","trip","transactions","usd","toNT","list","h1","t1","fromNT","sort","j","t2"],"mappings":";;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA,IAAMA,EAAE,GAAGC,OAAO,CAAC,UAAD,CAAlB;;AACA,IAAMC,IAAI,GAAGD,OAAO,CAAC,QAAD,CAApB;;AACA,IAAME,EAAE,GAAGH,EAAE,CAACG,EAAd;AAEAC,MAAM,CAACC,OAAP,GAAiB;AACfC,EAAAA,IAAI,EAAEN,EAAE,CAACO,KAAH,CAASC,QAAT,GAAoB,gBADX;AAGfC,EAAAA,IAAI,EAAE,iBAHS;AAKfC,EAAAA,QAAQ,EAAE,CAACP,EAAE,CAACQ,KAAH,CAAS,WAAT,CAAD,CALK;AAOf;AACAC,EAAAA,KAAK,EAAE,eAAUC,OAAV,EAAmBC,OAAnB,EAA4B;AACjC,QAAMC,EAAE,GAAGD,OAAO,CAACE,OAAR,CAAgBC,KAA3B;AACA,QAAMC,CAAC,GAAGH,EAAE,CAACI,YAAH,CAAgBN,OAAhB,CAAV,CAFiC,CAIjC;AACA;;AAEA,QAAIb,EAAE,CAACG,EAAH,CAAMiB,EAAN,CAAS,aAAT,KAA2BL,EAAE,CAACM,kBAAH,CAAsBR,OAAtB,CAA/B,EAA+D;AAC7D,aAAO,SAAP;AACD;;AACD,QAAIK,CAAC,CAAC,oCAAD,CAAL,EAA6C,OAAO,QAAP;AAE7C,WAAO,IAAP,CAZiC,CAYrB;AACb,GArBc;AAuBfI,EAAAA,MAAM,EAAE,gBAAUT,OAAV,EAAmBC,OAAnB,EAA4B;AAClC,QAAMS,UAAU,GAAGT,OAAO,CAACU,GAA3B;AACA,QAAMT,EAAE,GAAGD,OAAO,CAACG,KAAnB;AACA,QAAMd,EAAE,GAAGH,EAAE,CAACG,EAAd;AACA,QAAMsB,GAAG,GAAGvB,IAAI,CAACwB,SAAL,CAAe,qCAAf,CAAZ;AACA,QAAMC,IAAI,GAAGzB,IAAI,CAACwB,SAAL,CAAe,gCAAf,CAAb;AAEA,QAAME,GAAG,GAAGL,UAAU,CAACM,aAAX,CAAyB,KAAzB,CAAZ;AACAD,IAAAA,GAAG,CAACE,YAAJ,CAAiB,OAAjB,EAA0B,iBAA1B;AACAF,IAAAA,GAAG,CAACG,SAAJ,GAAgB,4BAAhB;;AAEA,QAAMC,QAAQ,GAAG,SAASA,QAAT,CAAmBC,OAAnB,EAA4BC,KAA5B,EAAmC;AAClD,UAAIA,KAAK,KAAKC,SAAd,EAAyBD,KAAK,GAAG,aAAR;AACzB,UAAME,GAAG,GAAGb,UAAU,CAACM,aAAX,CAAyB,KAAzB,CAAZ;AACAO,MAAAA,GAAG,CAACN,YAAJ,CAAiB,OAAjB,EAA0BI,KAA1B;AACAN,MAAAA,GAAG,CAACS,WAAJ,CAAgBD,GAAhB;AACAA,MAAAA,GAAG,CAACC,WAAJ,CAAgBd,UAAU,CAACe,cAAX,CAA0BL,OAA1B,CAAhB;AACD,KAND,CAXkC,CAmBlC;AACA;AACA;;;AAEA,QAAMf,CAAC,GAAGH,EAAE,CAACI,YAAH,CAAgBN,OAAhB,CAAV,CAvBkC,CAyBlC;AAEA;;AAEA,QAAM0B,UAAU,GAAG,SAASA,UAAT,CAAqB1B,OAArB,EAA8B2B,OAA9B,EAAuC;AACxD,UAAMC,KAAK,GAAG,IAAIvC,IAAI,CAACwC,KAAT,CAAe1C,EAAE,CAAC2C,KAAH,CAAS/B,KAAT,CAAeC,OAAf,CAAf,CAAd;AACA,UAAM+B,IAAI,GAAG,CAAC,MAAD,EAAS,aAAT,EAAwB,SAAxB,EAAmC,MAAnC,EAA2C,QAA3C,CAAb;AACA,UAAMC,CAAC,GAAG,EAAV;AACAD,MAAAA,IAAI,CAACE,OAAL,CAAa,UAAUC,CAAV,EAAa;AACxBN,QAAAA,KAAK,CAACG,IAAN,CAAWI,IAAX,CAAiBH,CAAC,CAACE,CAAD,CAAD,GAAO7C,IAAI,CAAC+C,QAAL,CAAcF,CAAd,CAAxB;AACD,OAFD,EAJwD,CAMrD;;AACHN,MAAAA,KAAK,CAACS,GAAN,CAAUC,GAAV,CAAcN,CAAC,CAACO,WAAhB,EAA6BzB,IAAI,CAAC,MAAD,CAAjC,EAA2Cd,OAA3C;AAEA,UAAMwC,GAAG,GAAGtC,EAAE,CAACuC,OAAH,EAAZ;AACAD,MAAAA,GAAG,CAACF,GAAJ,CAAQN,CAAC,CAACO,WAAV,EAAuBjD,EAAE,CAACoD,GAAH,CAAO,MAAP,CAAvB,EAAuCV,CAAC,CAACW,IAAzC,EAVwD,CAUT;;AAC/Cf,MAAAA,KAAK,CAACS,GAAN,CAAUO,QAAV,CAAmBT,IAAnB,CAAwBK,GAAxB;AAEAZ,MAAAA,KAAK,CAACS,GAAN,CAAUC,GAAV,CAAcN,CAAC,CAACO,WAAhB,EAA6BpD,EAAE,CAACG,EAAH,CAAMiB,EAAN,CAAS,MAAT,CAA7B,EAA+CyB,CAAC,CAACa,IAAjD;AAEAL,MAAAA,GAAG,CAACF,GAAJ,CAAQN,CAAC,CAACO,WAAV,EAAuBjD,EAAE,CAACwD,IAAH,CAAQ,SAAR,CAAvB,EAA2Cd,CAAC,CAACe,OAA7C;AACAnB,MAAAA,KAAK,CAACS,GAAN,CAAUO,QAAV,CAAmBT,IAAnB,CAAwBK,GAAxB,EAhBwD,CAkBxD;;AACAZ,MAAAA,KAAK,CAACS,GAAN,CAAUC,GAAV,CAAcN,CAAC,CAACO,WAAhB,EAA6BpD,EAAE,CAACG,EAAH,CAAMiB,EAAN,CAAS,QAAT,CAA7B,EAAiDyB,CAAC,CAACgB,MAAnD,EAnBwD,CAoBxD;;AAEA,UAAMC,YAAY,GAAG,SAAfA,YAAe,GAAY;AAC/B,YAAMC,KAAK,GAAG,EAAd;AACA,YAAMC,KAAK,GAAGjD,EAAE,CAACkD,IAAH,CAAQ9B,SAAR,EAAmBR,IAAI,CAAC,MAAD,CAAvB,EAAiCd,OAAjC,CAAd,CAF+B,CAG/B;;AACAmD,QAAAA,KAAK,CAAClB,OAAN,CAAc,UAAU5B,CAAV,EAAa;AACzB,cAAIgD,EAAE,GAAGnD,EAAE,CAACoD,GAAH,CAAOjD,CAAP,EAAUf,EAAE,CAACoD,GAAH,CAAO,MAAP,CAAV,CAAT,CADyB,CAEzB;;AACA,cAAI,CAACW,EAAL,EAASA,EAAE,GAAGlE,EAAE,CAACG,EAAH,CAAMiB,EAAN,CAAS,aAAT,CAAL;;AACT,cAAI8C,EAAE,IAAIA,EAAE,CAACE,GAAb,EAAkB;AAChB,gBAAMC,KAAK,GAAGH,EAAE,CAACE,GAAjB;AACA,gBAAI,CAACL,KAAK,CAACM,KAAD,CAAV,EAAmBN,KAAK,CAACM,KAAD,CAAL,GAAe,GAAf;AACnB,gBAAMC,GAAG,GAAGvD,EAAE,CAACwD,GAAH,CAAOrD,CAAP,EAAUlB,EAAE,CAACG,EAAH,CAAMiB,EAAN,CAAS,QAAT,CAAV,CAAZ;;AACA,gBAAI,CAACkD,GAAL,EAAU;AACRtC,cAAAA,QAAQ,CAAC,8BAA8BsC,GAA9B,GAAoC,OAApC,GAA8CpD,CAA/C,CAAR;AACD;;AACD,gBAAIoD,GAAJ,EAAS;AACPP,cAAAA,KAAK,CAACM,KAAD,CAAL,GAAeN,KAAK,CAACM,KAAD,CAAL,GAAeG,UAAU,CAACF,GAAG,CAACG,KAAL,CAAxC,CADO,CAEP;AACA;AACD;AACF;AACF,SAjBD;AAkBA,YAAIC,GAAG,GAAG,EAAV;AACA,YAAIC,KAAK,GAAG,CAAZ;AACA,YAAIC,UAAU,GAAG,GAAjB;;AACA,aAAK,IAAMR,GAAX,IAAkBL,KAAlB,EAAyB;AACvBW,UAAAA,GAAG,IAAI1E,EAAE,CAAC2C,KAAH,CAAS/B,KAAT,CAAeG,EAAE,CAAC8D,GAAH,CAAOT,GAAP,CAAf,IAA8B,IAA9B,GAAqCL,KAAK,CAACK,GAAD,CAA1C,GAAkD,IAAzD;AACAO,UAAAA,KAAK;AACLC,UAAAA,UAAU,IAAIb,KAAK,CAACK,GAAD,CAAnB;AACD;;AACDpC,QAAAA,QAAQ,CAAC,eAAegC,KAAK,CAACc,MAArB,GAA8B,iBAA9B,GAAkDJ,GAAnD,EAAwD,EAAxD,CAAR,CA9B+B,CA8BqC;;AACpE,YAAIC,KAAK,GAAG,CAAZ,EAAe;AACb3C,UAAAA,QAAQ,CAAC,kBAAkB4C,UAAnB,EAA+B,uBAA/B,CAAR;AACD;AACF,OAlCD;;AAmCA,UAAMG,QAAQ,GAAG/E,EAAE,CAACgF,KAAH,CAASzD,UAAT,EAAqB;AACpCkB,QAAAA,KAAK,EAAEA,KAD6B;AAEpCwC,QAAAA,MAAM,EAAEnB;AAF4B,OAArB,CAAjB;AAIAtB,MAAAA,OAAO,CAACH,WAAR,CAAoB0C,QAApB;AACD,KA9DD,CA7BkC,CA6FlC;;;AAEA,QAAI/E,EAAE,CAACG,EAAH,CAAMiB,EAAN,CAAS,aAAT,KAA2BL,EAAE,CAACM,kBAAH,CAAsBR,OAAtB,CAA/B,EAA+D;AAC7D,UAAMqE,EAAE,GAAGnE,EAAE,CAACkD,IAAH,CAAQ9B,SAAR,EAAmBhC,EAAE,CAACoD,GAAH,CAAO,MAAP,CAAnB,EAAmC1C,OAAnC,CAAX;AACA,UAAMsE,OAAO,GAAG,EAAhB;AACA,UAAMC,KAAK,GAAG,EAAd;;AACA,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGH,EAAE,CAACJ,MAAvB,EAA+BO,CAAC,EAAhC,EAAoC;AAClC,YAAMrB,KAAK,GAAGkB,EAAE,CAACG,CAAD,CAAhB;AACA,YAAMC,IAAI,GAAGvE,EAAE,CAACwD,GAAH,CAAOP,KAAP,EAAcrC,IAAI,CAAC,MAAD,CAAlB,CAAb;;AACA,YAAI,CAAC2D,IAAL,EAAW;AACTH,UAAAA,OAAO,CAACnC,IAAR,CAAagB,KAAb;AACD,SAFD,MAEO;AACL,cAAI,EAAEA,KAAK,IAAIoB,KAAX,CAAJ,EAAuBA,KAAK,CAACE,IAAD,CAAL,GAAc;AAAEvB,YAAAA,KAAK,EAAE,CAAT;AAAYwB,YAAAA,YAAY,EAAE;AAA1B,WAAd;AACvB,cAAMC,GAAG,GAAGzE,EAAE,CAACwD,GAAH,CAAOP,KAAP,EAAchE,EAAE,CAACG,EAAH,CAAMiB,EAAN,CAAS,QAAT,CAAd,CAAZ;AACA,cAAIoE,GAAJ,EAASJ,KAAK,CAACE,IAAD,CAAL,CAAYvB,KAAZ,IAAqByB,GAArB;AACT,cAAM9B,IAAI,GAAG3C,EAAE,CAACwD,GAAH,CAAOP,KAAP,EAAchE,EAAE,CAACG,EAAH,CAAMiB,EAAN,CAAS,MAAT,CAAd,CAAb;AACAgE,UAAAA,KAAK,CAACE,IAAI,CAACG,IAAL,EAAD,CAAL,CAAmBF,YAAnB,CAAgCvC,IAAhC,CAAqC,CAACU,IAAD,EAAOM,KAAP,CAArC;AACD;AACF;AACD;AACN;AACA;AACA;AACA;;;AACM,UAAM0B,IAAI,GAAG,EAAb;;AACA,WAAK,IAAMC,EAAX,IAAiBP,KAAjB,EAAwB;AACtB,YAAMQ,EAAE,GAAG7E,EAAE,CAAC8E,MAAH,CAAUF,EAAV,CAAX;AACAD,QAAAA,IAAI,CAAC1C,IAAL,CAAU,CAACjC,EAAE,CAACwD,GAAH,CAAOqB,EAAP,EAAWnE,GAAG,CAAC,SAAD,CAAd,CAAD,EAA6BmE,EAA7B,CAAV;AACD;;AACDF,MAAAA,IAAI,CAACI,IAAL;;AACA,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGL,IAAI,CAACZ,MAAzB,EAAiCiB,CAAC,EAAlC,EAAsC;AACpC,YAAMC,EAAE,GAAGN,IAAI,CAACK,CAAD,CAAJ,CAAQ,CAAR,CAAX;AACAxD,QAAAA,UAAU,CAACyD,EAAD,EAAKpE,GAAL,CAAV;AACD,OA/B4D,CAiC7D;;AACD,KAlCD,MAkCO,IAAIV,CAAC,CAAC,oCAAD,CAAL,EAA6C;AAClDqB,MAAAA,UAAU,CAAC1B,OAAD,EAAUe,GAAV,CAAV;AACD,KAnIiC,CAqIlC;;;AAEA,WAAOA,GAAP;AACD;AA/Jc,CAAjB,C,CAiKA","sourcesContent":["/*   Trip Pane\n **\n ** This pane deals with trips themselves and also\n ** will look at transactions organized by trip.\n **\n **  This outline pane allows a user to interact with a transaction\n **  downloaded from a bank statement, annotting it with classes and comments,\n **  trips, etc\n */\n\nconst UI = require('solid-ui')\nconst $rdf = require('rdflib')\nconst ns = UI.ns\n\nmodule.exports = {\n  icon: UI.icons.iconBase + 'noun_62007.svg',\n\n  name: 'travel expenses',\n\n  audience: [ns.solid('PowerUser')],\n\n  // Does the subject deserve this pane?\n  label: function (subject, context) {\n    const kb = context.session.store\n    const t = kb.findTypeURIs(subject)\n\n    // if (t['http://www.w3.org/2000/10/swap/pim/qif#Transaction']) return \"$$\";\n    // if(kb.any(subject, UI.ns.qu('amount'))) return \"$$$\"; // In case schema not picked up\n\n    if (UI.ns.qu('Transaction') in kb.findSuperClassesNT(subject)) {\n      return 'by Trip'\n    }\n    if (t['http://www.w3.org/ns/pim/trip#Trip']) return 'Trip $'\n\n    return null // No under other circumstances (while testing at least!)\n  },\n\n  render: function (subject, context) {\n    const myDocument = context.dom\n    const kb = context.store\n    const ns = UI.ns\n    const CAL = $rdf.Namespace('http://www.w3.org/2002/12/cal/ical#')\n    const TRIP = $rdf.Namespace('http://www.w3.org/ns/pim/trip#')\n\n    const div = myDocument.createElement('div')\n    div.setAttribute('class', 'transactionPane')\n    div.innerHTML = '<h2>Trip transactions</h2>'\n\n    const complain = function complain (message, style) {\n      if (style === undefined) style = 'color: grey'\n      const pre = myDocument.createElement('pre')\n      pre.setAttribute('style', style)\n      div.appendChild(pre)\n      pre.appendChild(myDocument.createTextNode(message))\n    }\n\n    // //////////////////////////////////////////////////////////////////////////////\n    //\n    //   Body of trip pane\n\n    const t = kb.findTypeURIs(subject)\n\n    // var me = UI.authn.currentUser()\n\n    //      Function: Render a single trip\n\n    const renderTrip = function renderTrip (subject, thisDiv) {\n      const query = new $rdf.Query(UI.utils.label(subject))\n      const vars = ['date', 'transaction', 'comment', 'type', 'in_USD']\n      const v = {}\n      vars.forEach(function (x) {\n        query.vars.push((v[x] = $rdf.variable(x)))\n      }) // Only used by UI\n      query.pat.add(v.transaction, TRIP('trip'), subject)\n\n      const opt = kb.formula()\n      opt.add(v.transaction, ns.rdf('type'), v.type) // Issue: this will get stored supertypes too\n      query.pat.optional.push(opt)\n\n      query.pat.add(v.transaction, UI.ns.qu('date'), v.date)\n\n      opt.add(v.transaction, ns.rdfs('comment'), v.comment)\n      query.pat.optional.push(opt)\n\n      // opt = kb.formula();\n      query.pat.add(v.transaction, UI.ns.qu('in_USD'), v.in_USD)\n      // query.pat.optional.push(opt);\n\n      const calculations = function () {\n        const total = {}\n        const trans = kb.each(undefined, TRIP('trip'), subject)\n        // complain(\"@@ Number of transactions in this trip: \" + trans.length);\n        trans.forEach(function (t) {\n          let ty = kb.the(t, ns.rdf('type'))\n          // complain(\" -- one trans: \"+t.uri + ' -> '+kb.any(t, UI.ns.qu('in_USD')));\n          if (!ty) ty = UI.ns.qu('ErrorNoType')\n          if (ty && ty.uri) {\n            const tyuri = ty.uri\n            if (!total[tyuri]) total[tyuri] = 0.0\n            const lit = kb.any(t, UI.ns.qu('in_USD'))\n            if (!lit) {\n              complain('    @@ No amount in USD: ' + lit + ' for ' + t)\n            }\n            if (lit) {\n              total[tyuri] = total[tyuri] + parseFloat(lit.value)\n              // complain('      Trans type ='+ty+'; in_USD \"' + lit\n              //       +'; total[tyuri] = '+total[tyuri]+';')\n            }\n          }\n        })\n        let str = ''\n        let types = 0\n        let grandTotal = 0.0\n        for (const uri in total) {\n          str += UI.utils.label(kb.sym(uri)) + ': ' + total[uri] + '; '\n          types++\n          grandTotal += total[uri]\n        }\n        complain('Totals of ' + trans.length + ' transactions: ' + str, '') // @@@@@  yucky -- need 2 col table\n        if (types > 1) {\n          complain('Overall net: ' + grandTotal, 'text-treatment: bold;')\n        }\n      }\n      const tableDiv = UI.table(myDocument, {\n        query: query,\n        onDone: calculations\n      })\n      thisDiv.appendChild(tableDiv)\n    }\n\n    //          Render the set of trips which have transactions in this class\n\n    if (UI.ns.qu('Transaction') in kb.findSuperClassesNT(subject)) {\n      const ts = kb.each(undefined, ns.rdf('type'), subject)\n      const triples = []\n      const index = []\n      for (let i = 0; i < ts.length; i++) {\n        const trans = ts[i]\n        const trip = kb.any(trans, TRIP('trip'))\n        if (!trip) {\n          triples.push(trans)\n        } else {\n          if (!(trans in index)) index[trip] = { total: 0, transactions: [] }\n          const usd = kb.any(trans, UI.ns.qu('in_USD'))\n          if (usd) index[trip].total += usd\n          const date = kb.any(trans, UI.ns.qu('date'))\n          index[trip.toNT()].transactions.push([date, trans])\n        }\n      }\n      /*            var byDate = function(a,b) {\n                      return new Date(kb.any(a, CAL('dtstart'))) -\n                              new Date(kb.any(b, CAL('dtstart')));\n                  }\n      */\n      const list = []\n      for (const h1 in index) {\n        const t1 = kb.fromNT(h1)\n        list.push([kb.any(t1, CAL('dtstart')), t1])\n      }\n      list.sort()\n      for (let j = 0; j < list.length; j++) {\n        const t2 = list[j][1]\n        renderTrip(t2, div)\n      }\n\n      //       Render a single trip\n    } else if (t['http://www.w3.org/ns/pim/trip#Trip']) {\n      renderTrip(subject, div)\n    }\n\n    // if (!me) complain(\"You do not have your Web Id set. Set your Web ID to make changes.\");\n\n    return div\n  }\n}\n// ends\n"],"file":"tripPane.js"}