{"version":3,"sources":["../src/preferences.js"],"names":["kb","require","solidLogicSingleton","store","ns","authn","widgets","pad","participation","$rdf","module","exports","value","get","k","set","v","debug","log","Error","renderPreferencesForm","recordSharedPreferences","getPreferencesForClass","subject","context","Promise","resolve","reject","sharedPreferences","any","ui","sp","sym","doc","uri","ins","st","updater","update","ok","errorMessage","recordPersonalDefaults","theClass","logInLoadPreferences","then","preferencesFile","preferencesFileError","regs","each","solid","prefs","reg","length","forEach","r","personalDefaults","newThing","rdf","push","errm","err","preferencesForm","prefContainer","dom","createElement","participationObject","me","heading","text","appendChild","textContent","noun","appendForm","mes","complain","errorMessageBlock","toJS","term","datatype","equals","xsd","Date","Number","predicates","results","pred","v1"],"mappings":"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","sourcesContent":["//                  Solid-UI temporary preferences\n//                  ==============================\n//\n\nimport * as debug from './debug'\n\nconst kb = require('./logic').solidLogicSingleton.store\nconst ns = require('./ns')\nconst authn = require('./authn/authn')\nconst widgets = require('./widgets')\nconst pad = require('./pad')\nconst participation = require('./participation')\nconst $rdf = require('rdflib')\n\n// This was tabulator . preferences in the tabulator\n//\nmodule.exports = {\n  // used for storing user name\n  value: [],\n  get: function (k) {\n    // original\n    return this.value[k]\n  },\n  set: function (k, v) {\n    if (typeof v !== 'string') {\n      debug.log('Non-string value of preference ' + k + ': ' + v)\n      throw new Error('Non-string value of preference ' + k + ': ' + v)\n    }\n    this.value[k] = v\n  },\n  renderPreferencesForm,\n  recordSharedPreferences,\n  getPreferencesForClass\n}\n// In a solid world, Preferences are stored in the web\n//\n// Make an RDF node for recording the common view preferences for any object\n// (maybe make it in a separate file?)\nfunction recordSharedPreferences (subject, context) {\n  return new Promise(function (resolve, reject) {\n    const sharedPreferences = kb.any(subject, ns.ui('sharedPreferences'))\n    if (!sharedPreferences) {\n      const sp = $rdf.sym(subject.doc().uri + '#SharedPreferences')\n      const ins = [\n        $rdf.st(subject, ns.ui('sharedPreferences'), sp, subject.doc())\n      ]\n      debug.log('Creating shared preferences ' + sp)\n      kb.updater.update([], ins, function (uri, ok, errorMessage) {\n        if (!ok) {\n          reject(new Error('Error creating shared prefs: ' + errorMessage))\n        } else {\n          context.sharedPreferences = sp\n          resolve(context)\n        }\n      })\n    } else {\n      context.sharedPreferences = sharedPreferences\n      resolve(context)\n    }\n  })\n}\n\n// Construct a personal defaults node in the preferences file for a given class of object\n//\nfunction recordPersonalDefaults (theClass, context) {\n  return new Promise(function (resolve, reject) {\n    authn.logInLoadPreferences(context).then(\n      context => {\n        if (!context.preferencesFile) {\n          debug.log(\n            'Not doing private class preferences as no access to preferences file. ' +\n              context.preferencesFileError\n          )\n          return\n        }\n        const regs = kb.each(\n          null,\n          ns.solid('forClass'),\n          theClass,\n          context.preferencesFile\n        )\n        let ins = []\n        let prefs\n        let reg\n        if (regs.length) {\n          // Use existing node if we can\n          regs.forEach(r => {\n            prefs = prefs || kb.any(r, ns.solid('personalDefaults'))\n          })\n          if (prefs) {\n            context.personalDefaults = prefs // Found one\n            resolve(context)\n            return\n          } else {\n            prefs = widgets.newThing(context.preferencesFile)\n            reg = regs[0]\n          }\n        } else {\n          // no regs fo class\n          reg = widgets.newThing(context.preferencesFile)\n          ins = [\n            $rdf.st(\n              reg,\n              ns.rdf('type'),\n              ns.solid('TypeRegistration'),\n              context.preferencesFile\n            ),\n            $rdf.st(reg, ns.solid('forClass'), theClass, context.preferencesFile)\n          ]\n        }\n        prefs = widgets.newThing(context.preferencesFile)\n        ins.push(\n          $rdf.st(\n            reg,\n            ns.solid('personalDefaults'),\n            prefs,\n            context.preferencesFile\n          )\n        )\n        kb.updater.update([], ins, function (uri, ok, errm) {\n          if (!ok) {\n            reject(new Error('Setting preferences for ' + theClass + ': ' + errm))\n          } else {\n            context.personalDefaults = prefs\n            resolve(context)\n          }\n        })\n      },\n      err => {\n        reject(err)\n      }\n    )\n  })\n}\n\nfunction renderPreferencesForm (subject, theClass, preferencesForm, context) {\n  const prefContainer = context.dom.createElement('div')\n  participation.participationObject(subject, subject.doc(), context.me).then(\n    participation => {\n      const dom = context.dom\n      function heading (text) {\n        prefContainer.appendChild(dom.createElement('h5')).textContent = text\n      }\n      heading('My view of this ' + context.noun)\n      widgets.appendForm(\n        dom,\n        prefContainer,\n        {},\n        participation,\n        preferencesForm,\n        subject.doc(),\n        (ok, mes) => {\n          if (!ok) widgets.complain(context, mes)\n        }\n      )\n\n      heading(\"Everyone's  view of this \" + context.noun)\n      recordSharedPreferences(subject, context).then(context => {\n        const sharedPreferences = context.sharedPreferences\n        widgets.appendForm(\n          dom,\n          prefContainer,\n          {},\n          sharedPreferences,\n          preferencesForm,\n          subject.doc(),\n          (ok, mes) => {\n            if (!ok) widgets.complain(context, mes)\n          }\n        )\n\n        heading('My default view of any ' + context.noun)\n        recordPersonalDefaults(theClass, context).then(\n          context => {\n            widgets.appendForm(\n              dom,\n              prefContainer,\n              {},\n              context.personalDefaults,\n              preferencesForm,\n              context.preferencesFile,\n              (ok, mes) => {\n                if (!ok) widgets.complain(context, mes)\n              }\n            )\n          },\n          err => {\n            widgets.complain(context, err)\n          }\n        )\n      })\n    },\n    err => {\n      // parp object fails\n      prefContainer.appendChild(widgets.errorMessageBlock(context.dom, err))\n    }\n  )\n  return prefContainer\n}\n\n// This should be part of rdflib.js ad part of the RDFJS Standard!!\n\nfunction toJS (term) {\n  if (!term.datatype) return term // Objects remain objects\n  if (term.datatype.equals(ns.xsd('boolean'))) {\n    return term.value === '1'\n  }\n  if (\n    term.datatype.equals(ns.xsd('dateTime')) ||\n    term.datatype.equals(ns.xsd('date'))\n  ) {\n    return new Date(term.value)\n  }\n  if (\n    term.datatype.equals(ns.xsd('integer')) ||\n    term.datatype.equals(ns.xsd('float')) ||\n    term.datatype.equals(ns.xsd('decimal'))\n  ) {\n    return Number(term.value)\n  }\n  return term.value\n}\n\n// This is the function which acuakly reads and combines the preferences\n//\n//  @@ make it much more tolerant of missing buts of prefernces\nfunction getPreferencesForClass (subject, theClass, predicates, context) {\n  return new Promise(function (resolve, reject) {\n    recordSharedPreferences(subject, context).then(context => {\n      const sharedPreferences = context.sharedPreferences\n      if (context.me) {\n        participation\n          .participationObject(subject, subject.doc(), context.me)\n          .then(participation => {\n            recordPersonalDefaults(theClass, context).then(context => {\n              const results = []\n              const personalDefaults = context.personalDefaults\n              predicates.forEach(pred => {\n                // Order of preference: My settings on object, Global settings on object, my settings on class\n                const v1 =\n                  kb.any(participation, pred) ||\n                  kb.any(sharedPreferences, pred) ||\n                  kb.any(personalDefaults, pred)\n                if (v1) {\n                  results[pred.uri] = toJS(v1)\n                }\n              })\n              resolve(results)\n            }, reject)\n          }, reject)\n      } else {\n        // no user defined, just use common prefs\n        const results = []\n        predicates.forEach(pred => {\n          const v1 = kb.any(sharedPreferences, pred)\n          if (v1) {\n            results[pred.uri] = toJS(v1)\n          }\n        })\n        resolve(results)\n      }\n    })\n  })\n}\n\n// ends\n"],"file":"preferences.js"}